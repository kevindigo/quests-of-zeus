<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Oracle of Delphi - A board game PWA">
    <meta name="theme-color" content="#1a202c">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/assets/icon-192.png">

    <title>Oracle of Delphi</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
      }

      .container {
        text-align: center;
        padding: 2rem;
        max-width: 1200px;
        width: 100%;
      }

      h1 {
        font-size: 3rem;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .subtitle {
        font-size: 1.2rem;
        margin-bottom: 2rem;
        opacity: 0.9;
      }

      .status {
        background: rgba(255, 255, 255, 0.1);
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        backdrop-filter: blur(10px);
      }

      .features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
      }

      .feature {
        background: rgba(255, 255, 255, 0.1);
        padding: 1rem;
        border-radius: 8px;
        backdrop-filter: blur(10px);
      }

      footer {
        margin-top: 2rem;
        opacity: 0.7;
        font-size: 0.9rem;
      }

      .game-ui {
        margin: 2rem 0;
        background: rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
        border-radius: 8px;
        backdrop-filter: blur(10px);
      }

      .game-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }

      button {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .map-display {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        max-height: 300px;
        overflow-y: auto;
      }

      .hex-map-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        backdrop-filter: blur(10px);
        overflow: auto;
        max-height: 800px;
      }

      .hex-map-svg {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        height: auto;
      }

      .svg-controls {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }

      .svg-controls button {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
      }

      .cell-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 0.5rem;
        border-radius: 4px;
        margin-top: 1rem;
        font-size: 0.9rem;
      }

      .cell-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .cell-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
      }

      .terrain-sea {
        background: rgba(0, 119, 190, 0.3);
      }
      .terrain-coast {
        background: rgba(173, 216, 230, 0.3);
      }
      .terrain-plains {
        background: rgba(144, 238, 144, 0.3);
      }
      .terrain-hills {
        background: rgba(139, 69, 19, 0.3);
      }
      .terrain-mountains {
        background: rgba(128, 128, 128, 0.3);
      }
      .terrain-forest {
        background: rgba(34, 139, 34, 0.3);
      }
      .terrain-desert {
        background: rgba(238, 203, 173, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Oracle of Delphi</h1>
      <p class="subtitle">A Progressive Web App Board Game</p>

      <div class="status">
        <p>üöÄ Project skeleton loaded successfully</p>
        <p>üó∫Ô∏è Hex Map Engine loaded (hexagon radius 6)</p>
        <p>üíª Now entirely client-side!</p>
      </div>

      <div class="game-ui">
        <h3>Game Controls</h3>
        <div class="game-controls">
          <button id="generateMap">Generate New Map</button>
          <button id="showMapData">Show Map Data</button>
          <button id="showHexMap" style="display: none">Show Hex Map</button>
        </div>

        <div id="mapInfo" class="map-display" style="display: none"></div>
        <div id="hexMapContainer" class="hex-map-container">
          <div class="svg-controls">
            <button id="toggleCoordinates">Show Coordinates</button>
            <button id="toggleLabels">Show Labels</button>
            <button id="zoomIn">Zoom In</button>
            <button id="zoomOut">Zoom Out</button>
            <button id="resetZoom">Reset Zoom</button>
          </div>
          <div id="hexMapSVG"></div>
          <div id="cellInfo" class="cell-info" style="display: none"></div>
        </div>
      </div>

      <footer>
        <p>Built with Deno 2.5 ‚Ä¢ Progressive Web App ‚Ä¢ Client-Side Only</p>
      </footer>
    </div>

    <script type="module">
      import {
        generateNewMap,
        getCurrentMap,
        getMap,
        getMapStatistics,
      } from "./dist/hexmap.js";
      import { HexMapSVG } from "./dist/hexmap-svg.js";

      // Initialize the map when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Page loaded, initializing map...");
        // Generate initial map
        generateNewMap();
        console.log("Initial map generated");

        // Display the hex map by default
        renderHexMap();
      });

      // Service Worker Registration
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/sw.js")
            .then((registration) => {
              console.log("SW registered: ", registration);
            })
            .catch((registrationError) => {
              console.log(
                "SW registration failed: ",
                registrationError,
              );
            });
        });
      }

      // PWA Installation
      let deferredPrompt;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log("PWA installation available");
      });

      // Game UI Event Handlers
      document.getElementById("generateMap").addEventListener(
        "click",
        () => {
          generateNewMap();
          document.getElementById("mapInfo").style.display = "none";
          renderHexMap();
        },
      );

      document.getElementById("showMapData").addEventListener(
        "click",
        () => {
          const stats = getMapStatistics();
          const mapInfo = document.getElementById("mapInfo");

          mapInfo.style.display = "block";

          mapInfo.innerHTML = `
                <h3>Map Statistics</h3>
                <p><strong>Dimensions:</strong> ${stats.dimensions.width} √ó ${stats.dimensions.height}</p>
                <p><strong>Total Cells:</strong> ${stats.totalCells}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin: 1rem 0;">
                    ${
            Object.entries(stats.terrainCounts).map((
              [terrain, count],
            ) =>
              `<div class="cell-item terrain-${terrain}">
                            <strong>${terrain}:</strong> ${count}
                        </div>`
            ).join("")
          }
                </div>

                <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
                    Check console for full map data structure
                </p>
            `;

          console.log("Full map data:", getMap());
        },
      );

      // Hex Map SVG functionality
      let hexMapSVG;
      let currentOptions = {
        showCoordinates: false,
        showTerrainLabels: false,
        cellSize: 30,
      };

      document.getElementById("showHexMap").addEventListener(
        "click",
        () => {
          const hexMapContainer = document.getElementById(
            "hexMapContainer",
          );
          const mapInfo = document.getElementById("mapInfo");

          hexMapContainer.style.display = "block";
          mapInfo.style.display = "none";

          renderHexMap();
        },
      );

      function renderHexMap() {
        const gameMap = getCurrentMap();
        const grid = gameMap.serialize();

        hexMapSVG = new HexMapSVG({
          cellSize: currentOptions.cellSize,
          showCoordinates: currentOptions.showCoordinates,
          showTerrainLabels: currentOptions.showTerrainLabels,
          interactive: true,
        });

        const { svg, script } = hexMapSVG.generateInteractiveSVG(grid);
        const hexMapSVGElement = document.getElementById("hexMapSVG");
        hexMapSVGElement.innerHTML = svg;

        // Execute the script directly instead of creating a script element
        try {
          eval(script);
        } catch (error) {
          console.error("Error executing hex map script:", error);
        }

        // Listen for hex cell clicks
        document.addEventListener("hexCellClick", (event) => {
          const { q, r, terrain } = event.detail;
          const cellInfo = document.getElementById("cellInfo");
          cellInfo.style.display = "block";
          cellInfo.innerHTML = `
                    <h4>Selected Cell</h4>
                    <p><strong>Position:</strong> (${q}, ${r})</p>
                    <p><strong>Terrain:</strong> ${terrain}</p>
                    <p><strong>Coordinates:</strong> Axial (q=${q}, r=${r})</p>
                `;
        });
      }

      // SVG Controls
      document.getElementById("toggleCoordinates").addEventListener(
        "click",
        () => {
          currentOptions.showCoordinates = !currentOptions
            .showCoordinates;
          document.getElementById("toggleCoordinates").textContent =
            currentOptions.showCoordinates
              ? "Hide Coordinates"
              : "Show Coordinates";
          renderHexMap();
        },
      );

      document.getElementById("toggleLabels").addEventListener(
        "click",
        () => {
          currentOptions.showTerrainLabels = !currentOptions
            .showTerrainLabels;
          document.getElementById("toggleLabels").textContent =
            currentOptions.showTerrainLabels
              ? "Hide Labels"
              : "Show Labels";
          renderHexMap();
        },
      );

      document.getElementById("zoomIn").addEventListener(
        "click",
        () => {
          currentOptions.cellSize = Math.min(
            currentOptions.cellSize + 5,
            60,
          );
          renderHexMap();
        },
      );

      document.getElementById("zoomOut").addEventListener(
        "click",
        () => {
          currentOptions.cellSize = Math.max(
            currentOptions.cellSize - 5,
            20,
          );
          renderHexMap();
        },
      );

      document.getElementById("resetZoom").addEventListener(
        "click",
        () => {
          currentOptions.cellSize = 30;
          renderHexMap();
        },
      );
    </script>
  </body>
</html>
